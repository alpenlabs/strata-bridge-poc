use bitcoin::{
    block::Header,
    blockdata::block::Block,
    consensus::encode::{deserialize_hex, serialize_hex},
    hashes::Hash,
    merkle_tree::PartialMerkleTree,
    Transaction, Txid, WitnessCommitment, WitnessMerkleNode, Wtxid,
};
use serde::{de::Error, Deserialize, Deserializer, Serialize, Serializer};
use strata_primitives::{buf::Buf32, hash::compute_borsh_hash};
use strata_state::{
    bridge_state::DepositsTable, chain_state::HashedChainState, l1::HeaderVerificationState,
};

#[derive(Debug, Clone)]
pub struct InclusionProof(pub PartialMerkleTree);

/// Implement `Serialize` for `PartialMerkleTree` using hex encoding.
impl Serialize for InclusionProof {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: Serializer,
    {
        serializer.serialize_str(&serialize_hex(&self.0))
    }
}

/// Implement `Deserialize` for `PartialMerkleTree` using hex decoding.
impl<'de> Deserialize<'de> for InclusionProof {
    fn deserialize<D>(deserializer: D) -> Result<Self, D::Error>
    where
        D: Deserializer<'de>,
    {
        Ok(InclusionProof(
            deserialize_hex(&String::deserialize(deserializer)?).map_err(D::Error::custom)?,
        ))
    }
}

/// Parameters for Bridge Proof operations as a tuple.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct BridgeProofPublicParams {
    pub deposit_txid: [u8; 32],
    pub superblock_hash: [u8; 32],
    pub bridge_out_txid: [u8; 32],
    pub superblock_period_start_ts: u32,
}

pub trait WtxidToTxid {
    fn to_txid(&self) -> Txid;
}

impl WtxidToTxid for Wtxid {
    fn to_txid(&self) -> Txid {
        Txid::from_byte_array(self.to_byte_array())
    }
}

pub trait WithInclusionProof {
    fn with_inclusion_proof(&self, block: &Block) -> TransactionWithInclusionProof;
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TransactionWithInclusionProof {
    // Transaction and PMT for transaction (and coinbase) inclusion proof
    pub tx: (Transaction, InclusionProof),

    // Coinbase transaction and PMT for witness inclusion proof
    pub witness: Option<(Transaction, InclusionProof)>,
}

impl WithInclusionProof for Transaction {
    fn with_inclusion_proof(&self, block: &Block) -> TransactionWithInclusionProof {
        let (txids, wtxids): (Vec<_>, Vec<_>) = block
            .txdata
            .iter()
            .map(|tx| {
                (
                    tx.compute_txid(),
                    if tx.is_coinbase() {
                        Txid::all_zeros()
                    } else {
                        tx.compute_wtxid().to_txid()
                    },
                )
            })
            .unzip();

        let txid = self.compute_txid();
        let wtxid = self.compute_wtxid().to_txid();

        let (incl_txids, witness) = if txid == wtxid {
            // Non-Segwit
            (vec![txid], None)
        } else {
            // Segwit
            let coinbase_tx = block.txdata[0].clone();
            let coinbase_txid = coinbase_tx.compute_txid();
            (
                vec![coinbase_txid, txid],
                Some((
                    coinbase_tx,
                    InclusionProof(PartialMerkleTree::from_txids(
                        &wtxids,
                        &wtxids.iter().map(|&id| id == wtxid).collect::<Vec<_>>(),
                    )),
                )),
            )
        };

        TransactionWithInclusionProof {
            tx: (
                self.clone(),
                InclusionProof(PartialMerkleTree::from_txids(
                    &txids,
                    &txids
                        .iter()
                        .map(|id| incl_txids.contains(id))
                        .collect::<Vec<_>>(),
                )),
            ),
            witness,
        }
    }
}

impl TransactionWithInclusionProof {
    pub fn verify(&self, header: &Header) -> Result<(), Box<dyn std::error::Error>> {
        let (tx, InclusionProof(tx_pmt)) = &self.tx;

        let (txid, wtxid) = (tx.compute_txid(), tx.compute_wtxid().to_txid());
        let (mut txids, mut tx_indexes) = (vec![], vec![]);

        let merkle_root = tx_pmt.extract_matches(&mut txids, &mut tx_indexes)?;
        if merkle_root != header.merkle_root || !txids.contains(&txid) {
            return Err("invalid tx inclusion proof".into());
        }

        if txid != wtxid && !tx.is_coinbase() {
            let (coinbase_tx, InclusionProof(witness_pmt)) = self
                .witness
                .as_ref()
                .ok_or("witness: segwit tx requires witness proof")?;

            let coinbase_txid = coinbase_tx.compute_txid();
            if !coinbase_tx.is_coinbase() || !txids.contains(&coinbase_txid) {
                return Err("witness: invalid coinbase_tx inclusion proof".into());
            }

            // extract witness commitment from coinbase tx
            const MAGIC: [u8; 6] = [0x6a, 0x24, 0xaa, 0x21, 0xa9, 0xed];
            let coinbase_witness_commitment = coinbase_tx
                .output
                .iter()
                .rev()
                .find_map(|txout| txout.script_pubkey.as_bytes().strip_prefix(&MAGIC))
                .map(|data| WitnessCommitment::from_slice(data).unwrap())
                .ok_or("witness: no commitment in coinbase_tx")?;

            let witness_reserved_value: [u8; 32] = coinbase_tx.input[0]
                .witness
                .nth(0)
                .ok_or("witness: no reserved value in witness")?
                .try_into()?;

            let (mut wtxids, mut windexes) = (vec![], vec![]);
            let root = witness_pmt.extract_matches(&mut wtxids, &mut windexes)?;
            let witness_root = WitnessMerkleNode::from_raw_hash(root.to_raw_hash());
            let witness_commitment =
                Block::compute_witness_commitment(&witness_root, &witness_reserved_value);

            if witness_commitment != coinbase_witness_commitment || !wtxids.contains(&wtxid) {
                return Err("witness: invalid witness inclusion proof".into());
            }
        }

        Ok(())
    }
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct BridgeProofInput {
    /// headers after last verified l1 block
    pub headers: Vec<Header>,

    /// Deposit Txid
    pub deposit_txid: [u8; 32],

    /// Block height of checkpoint tx, and it's inclusion proof
    pub checkpoint: (u32, TransactionWithInclusionProof),

    /// Block height of bridge_out tx, and it's inclusion proof
    pub bridge_out: (u32, TransactionWithInclusionProof),

    /// Header verification state until last verified l1 block
    pub initial_header_state: HeaderVerificationState,

    /// superblock period start ts
    pub superblock_period_start_ts: u32,
}

#[derive(borsh::BorshSerialize, borsh::BorshDeserialize)]
pub struct StrataBridgeState {
    pub deposits_table: DepositsTable,
    pub hashed_chain_state: HashedChainState,
}

impl StrataBridgeState {
    pub fn compute_state_root(&self) -> Buf32 {
        let mut hashed_chain_state = self.hashed_chain_state;
        hashed_chain_state.deposits_hash = compute_borsh_hash(&self.deposits_table);
        compute_borsh_hash(&hashed_chain_state)
    }
}

#[cfg(test)]
mod tests {
    use std::{fs, str::FromStr};

    use bitcoin::{block, Block, BlockHash, Txid};
    use strata_proofimpl_btc_blockspace::tx;
    use strata_state::{
        batch::{BatchCheckpoint, SignedBatchCheckpoint},
        block::L2Block,
        chain_state::ChainState,
        header,
        l1::{L1BlockId, TimestampStore},
    };
    use strata_tx_parser::inscription::parse_inscription_data;

    use super::*;
    use crate::{bridge_proof::SUPERBLOCK_PERIOD_BLOCK_INTERVAL, process_bridge_proof};

    #[test]
    fn test_tx_inclusion_proofs() {
        let block = mock_block();

        for i in 0..block.txdata.len() {
            let tx = &block.txdata[i];
            let tx = tx.with_inclusion_proof(&block);
            if let Err(err) = tx.verify(&block.header) {
                panic!("{}", err);
            }
        }
    }

    fn mock_block() -> Block {
        let raw_block = "00000020199d72ea091f44ec7286496f0abb81077a0336de0211ca737ab8c1e80ca49917131004809b16f07085f1de56d589971ba7e9b19668e247ac8aab670edb10a10a91362d67ffff7f200000000004020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff0402140400ffffffff026052a8040000000016001406d6ede725893732fb24c3468ff3225b831686280000000000000000266a24aa21a9ed63cec465e04395952b19d5e7ee475e5de024db4c9f645710a16593b7603f62e6012000000000000000000000000000000000000000000000000000000000000000000000000002000000000101f831f68d0067e6de9056fe0c7b511974ab5f5126d8d0579ad4a40407bdce67c10000000000fdffffff020065cd1d0000000022512089a7d042371d88422ceb54561113151271292a868275768358e6d631c0a6a251b84573070000000016001481792d442db2a9ad84c74a26f7918a4e308a06f4024730440220747580d2f36bcb6b56783a6e3e566e7aa96a0e8c1f7a4e01c837c9615e1267cc022012bcc1faf75576d4bca16d0f843fd9309b1c5f1d216fc39c326b933bfb60b592012103b299d12b9a8ea09e377e477c4cebc56a4b8f23dea6d9de6897cf6f95997bd36700000000020000000001019266bda7bc96cea48d183dac4b7435c93a8ddbcaaf5606665793923639b1ecd70000000000fdffffff022e50cd1d000000002251203018dea7fc62d38c3d3afc051a09f05e29f54d52d44e9d17c2e7c1deee7a1a234a01000000000000225120a7aaff785702a464a0444e51b7ae3354999e1047c42c6df6e778e2928d155d7b9c140190c293401607c7abd285e565519460b9aa0f520014a6d918a8192ddad74485e198070dfb959ecf897301091428be1b30f99375046c7fff988ab65420a6832dec01031494ed1b9baaeeafb87ece23df80038ae2e10cdc97010f14738c4aeeb8e12502e3b9a2ca830bb95985c0a148010d14efc2b2fcdf5cabe1560b14989e37d469ba8d2b50010714612cda27bbd811684de1788d1d9a420e9cc27a82010b14fd65e0582755ec03e42b97c5b3158455cacc5e6201061401e5bbcd104f1936613bbba1c8d1935f406010a3010d149740d674d1f93aa05fadffd82fb6c8da1b32f059010814abfc8c527dcbca6ff2f91a35744e25705f3ac7f60014ca9c61114816a5c1812d07a2fb98e209c5b94853010114aab6b68a2a98ae2ea1215891c07575c309de05dd0101142db06d809617c2c356d695809efcd2330105fce201091429609ed3e469ac98f977298cfd5021e61617977f010714c7967496cefd40e76a4a30e3eb6e11e8d9d6c30e0014c433d8f172ef70e972d263a689864b224de11005010a149388050bc91744c48f8bfa2e2b07264277a10ad901031475e0da964c1f07832acbdc6692837107cb7890fd010714e43981a0b4f765dccfd3c7567092fc1cacc27871010e140fed5286152be800f943a3d9b9b36e8fc3bc2f8f010b14ff5e0f9a35791ce0c826ae7294cab87d124f62e3010c143776eb4bd1d4ae34aa0bad57dd337a6405e48822010114b63e650abab8b6315449f9b0d45f3a323b60de630108145a1b5cc9cba790e32cdfdbce6b1505b02b01e25101061473bcaa481c98e932a84ce0b62ee195278ee9d043010614724b54a2a94fd901e0de81c13ee45801abf36511010b14c2862ef1117d6df35685279b9f031b8e985cd47901081471bb41e5c82df66f63916f99a282e8375c184e85010b14fd90915c3ac9dc5d7b671be38505b8c807d56f75010d1481e06aa08704bc512d8717064dadf60fe9464ee600149dac8e1a366c2936fedd77c7c3e5074dedfecf45010b148086544ab7ab9c23b62c5d05d278083dc2eee3a9010f141f41c97b827a45ac1c8ca9c1ac130efdb57513020108140ba501a1cb7650a5f142a5e1f6b48029d8595706010d149a555a0fbd1e1727f767952be6b2abca6c50115f010214b29d597f01751ecc5afa7d16a8cb0a8f8727d6ee010d14886f32d8a0cd91c28a35463090c79e70cf8c650b0014e9ad75f35c43e12699726706c6b6f09734fbd3b501081422cc4b22ae998b2e22d3e07c0fa4dd7bf61810e1010d147a4a6bb9a9b96eea6f6c09958bedbb34ce7414e2010b143eac537d1e0b5b48c97d4f20ddb85939b6ac840a010d143b601c122713751951232be56ea3a67b9922a39a0103141559a393b34ccfaaf3e5278010b3b7b22f5f97d1010614a8852918dd2f198c0a6058808b8c24a8d23ab1e6010b148c63a70e5dc25b8500a7256d98654b66f451aef401061494fe708a6497476b72a3c55c004c000388dec37a010114f0cbd2b7387b0fddb318202a2c628ccf3a5866700109146fa8950a0edb25ce98cc9cfc31abc32e8143a87c010e14f8836f376a3e7cafe10c15a18ebf5c4aff5a6e7b010714598bff0f93341d3f12756e3e8507cc41e74bd38c010714b8c494fd875a95c00d139b08238fd64fa685d8e5010a1497f119df32da966a2d10129722bb2b08e937ec52010e149c0d55e83f1797950eedc33d554dce23344ab5a001081448e31ec37f2ca4292e42dd0aaf0ac31251471b170104148761d4cac65268ce4a4e6ae525c0064b7f307b4801031480777f57a9381c7efc366872aeb9d7337cf0ae82010114dfe66ff0a42ea45ead708b62be5380421010af82010c14b589a7c7c858165bf5be6589da033cdaf40867fb010414a7b9787079c534818517b30a0b9876fd338a39a9010814e8f839236da2bbde9fbf8a5c4d6f8b8700cde6b5010b14e9596c60538548f124a98489cede7552806667ac010f145fa9b905e895d2ef4bf7530e114e8db6bc77b7c6010414fbda2f6109896cdf661a09c0425c72b9a74de467010e14a6f77b5693ca187b54a580e78ae00a7b9c6bf917010114cb096ba10690a6c612904e9be9fd5fae7db1e536010c14def61f342e830008e5cf47cb9e191d6cb2b76224010914e7eb59d652516009c287d4daf12a540f2b9916aa0106142d92774a63b543617ff0db516cca51d522fd7c2801071420720ca49532b2299fdee67b82e3c17af8fbe243010214456277e8cbcb1b91b5436fc9286f9148e918987a010d14e9eb57f8727a6580fafe4cf5060eec517ddd8594010314612866ca8152440afddc35bb93cd14a14652e9d0010614d21d9fc3fb4cda2d51eacd0ee40e5ffe15d9ee55010914199ea52c8357f2d34059cce6e6a1a7db686002520014a66b7963d0c2686cb8d7c8922a226f7622832f7e010414a3eecb930ffe0ab617449b932dacc9521f09730d010afd4d155fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914a60ab568a4139fdfa12925107655218b67d8349a886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914fdf4310c23862b4d7040239d7acd819f5d5358d8886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79149307217a5070bf2d29fea1cdbe8720537301966b886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79141ac3b41961ac53327b5da05db1a7b93e2151255e886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79140cc118252321429e065e62c5fe9dc53f36f963f4886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914afbf5b2f48975221a20c2697194be4048e68268e886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79145abf490129ae3dd8a61c6f5414b5d63c49700301886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79148e379dfef16a2131c5874acac6fb2c02e7f4c54c886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914f4476db874e210e9a28fbc6e61a066e0ebd10580886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914261fbbb1c199841d43d94346a79578b4cd60948b886d6d6d6d6d6d6d6d6c768f6c7d946c7d946c7d946c7d946c7d946c7d946c7d940178936c76937693769376936c93886d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79147eb35877d2dcc22d844a6426952e23870e1f1692886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791480bb0e9e84060baccc1e403149ec38f082583698886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79143167523687f6d65aa7ac40d5a87287fddbfee073886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914642704e1ea59f544b28c8c3b8fe535b09f260169886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79143b10e77e26f17019e38d1db70b9a3ece322e6030886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914e9596c60538548f124a98489cede7552806667ac886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914cd3870ca469f42e1d9b4b66d624038cad62d3e2c886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914afd72e092e59679a7bd77412bb177ded76d6f5fd886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79145a3fda8362a69aa87851d001cfacffc0cb259bb9886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791437947ba21d964946f44fb93ad90a75dd60c9208f886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791480e02093a3b7c66e8814eda2ac2688a91a7df653886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791420bd264f2bf9735e44f0e434b481fa6205877845886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914373dec50f0b9d9fcc6347aa692bfb3c169f9a106886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791401bded839b07015d064f18d4b1233bb68dc75066886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791491d324d0ef7e1e44bf37eb69ae811cd204af07a5886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914804db0c593bbe21d175997c12b430dea5fdaf5ef886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914d32177c17b4824308caa9273111e8bc2eedf3dcc886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914524e9199175bd3e2b41a817a0f954166e3184057886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914e2aefc27344e7f86206e6d743cb2259879778743886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914ed56aadfdfa8574ad4f3dfeb4c7356efc03a0d5a886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914a860031c16654fe4246e97c9668a308d9ad384f5886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79148c66c104638b1f03d4064fed1922e90ffc988f96886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914d75113e9f6b155c8e03e295714c8563272adb7a5886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791471d7299596281e482359fe54e557e7afbf0cc72c886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914ad33fc91ecd665474fb62eacb3043160728addfc886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914dc427189fc43ab8f68dc6550cd409a8435015d96886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914669974f716290360cd74038cbd6f91f0a5977f35886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914108db6c268f93a822ccdc21df85e56a7ccf3311f886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914ecf5362ca72da42dff94d5f089d29d0e21e77a7b886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914920cdf47c64a2e02900e1445997cd145b06d7476886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79147e0beed465bd6439937b6ce2a7e538e5bebfb808886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79146d95b41bf9ffde47e29f1b2f075bbc36784ca904886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791435f39e3bd84ba2f72da240c47a99d731a4d98e49886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914e7d4d105a998025ecd7ce879a01096eaf08788e0886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79148086544ab7ab9c23b62c5d05d278083dc2eee3a9886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791414745914dd1e27c9d5880b2650fd335c43a012ad886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914b854bd58749dbfdc5a7a946422c8d8d38c6da2bb886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791496767d7f2a46782bcc33e8a67b69b760f458e753886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791434d3e425b27eba82ffb3a8586e52bccaefac052f886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791426eb18968ab6c5528d193035bf3c9e701ddc1df6886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791442158a99df1b7de50663ee323f5230d1e09b3d28886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79149e4268dae1974eb4b9692ae845b587773389a0c9886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79148cfc4a3a86a478313aa393bede2da011383751d3886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791412d302f706cfcca72de7890048b729fa76c809e8886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791490afe51362c6453e2b02923431dcc10be996ce20886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914512df486b9bce7b37e6558810733492d28ded05c886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914ba48ef5f17acd51c9fabfce97104272f75b60920886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79144574f22897336dd371d439aedaaa21659b26c329886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914dbbacb572f0cf06979337ec67a5c1f0fa669b67e886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914d6dede42dce15c038ebd2333595300befd24b3df886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914142d7535c8a8d5e3daba33b709ba0aee470a624b886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79142c488b01d6c29c9d505ea9e911d852799763d347886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79144b4ae8c33e7bebfc4444c1876ce4ddba39c5a571886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79145432efcdf237c67a82b3471e1c8d05ad884badd6886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79141847bf31c0106b95fca844e71a1d127bbd547b3a886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79144d80ee741232108315adc32cce13579ba4d5823b886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791412dc8d66655423d28cbd9ce0b06c82967bc86183886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791432de3fb1cf461e89a97c34c4cd416dfe2660d02b886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79146415e57e8525ef9b26728d84af7c56a62066471d886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79141aadd8d939a02a0d7dd6d8d4fad316478a1750ad886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914b1599f4fde540110f50ec4fa864a7b64e602b619886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914f09e4798f0774b85afb5f56cd4f1c4fd5f05893d886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c79142ac1a87f8f8847a200726dc9c5e2ce428259a40c886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c791494ed1b9baaeeafb87ece23df80038ae2e10cdc97886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914696eb4a0b5bbfc59f5caf296acdcd1b3c4542e6b886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914dde1e293f276be281eed76c4fda165706ae549aa886d6d6d6d6d6d6d6d5fa3766b6b76a976a976a976a976a976a976a976a976a976a976a976a976a976a976a96c7914806ad38a6ebef6167d1e0d1abe0b415fd3fd6baa886d6d6d6d6d6d6d6d6c768f6c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d946c7d9402c003936c76937693769376936c9376937693769376936c93886d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d5121c12be4d02127fedf4c956f8e6d8248420b9af78746232315f72894f0b263c80e810000000002000000000101b507cc00b0be5f8b63ea2ec84e57f1b1a5bedcad9ee68e6793ad5671714cc6b70000000000fdffffff3c98f0cc1d00000000225120a7aaff785702a464a0444e51b7ae3354999e1047c42c6df6e778e2928d155d7b4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251204288d1d887e0fc2511fb6131269c0f607f3440a696eff4fbb47c04215f10e5d14a010000000000002251203409a0a1b4dac615bbb610e5f129a1a0529f577557033dad24e22900b6409baa4a01000000000000225120dad7948aeda4c13ff9ef090f9b4948b972b4a559602e1e4b7aa8d53a564d87c84a010000000000002251202874162b92b8d3be94843507d3a2c27b533e61ae775a177e7317e935be89f04f4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251204288d1d887e0fc2511fb6131269c0f607f3440a696eff4fbb47c04215f10e5d14a010000000000002251203409a0a1b4dac615bbb610e5f129a1a0529f577557033dad24e22900b6409baa4a01000000000000225120dad7948aeda4c13ff9ef090f9b4948b972b4a559602e1e4b7aa8d53a564d87c84a010000000000002251202874162b92b8d3be94843507d3a2c27b533e61ae775a177e7317e935be89f04f4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251204288d1d887e0fc2511fb6131269c0f607f3440a696eff4fbb47c04215f10e5d14a010000000000002251203409a0a1b4dac615bbb610e5f129a1a0529f577557033dad24e22900b6409baa4a01000000000000225120dad7948aeda4c13ff9ef090f9b4948b972b4a559602e1e4b7aa8d53a564d87c84a010000000000002251202874162b92b8d3be94843507d3a2c27b533e61ae775a177e7317e935be89f04f4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251204288d1d887e0fc2511fb6131269c0f607f3440a696eff4fbb47c04215f10e5d14a010000000000002251203409a0a1b4dac615bbb610e5f129a1a0529f577557033dad24e22900b6409baa4a01000000000000225120dad7948aeda4c13ff9ef090f9b4948b972b4a559602e1e4b7aa8d53a564d87c84a010000000000002251202874162b92b8d3be94843507d3a2c27b533e61ae775a177e7317e935be89f04f4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251204288d1d887e0fc2511fb6131269c0f607f3440a696eff4fbb47c04215f10e5d14a010000000000002251203409a0a1b4dac615bbb610e5f129a1a0529f577557033dad24e22900b6409baa4a01000000000000225120dad7948aeda4c13ff9ef090f9b4948b972b4a559602e1e4b7aa8d53a564d87c84a010000000000002251202874162b92b8d3be94843507d3a2c27b533e61ae775a177e7317e935be89f04f4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251204288d1d887e0fc2511fb6131269c0f607f3440a696eff4fbb47c04215f10e5d14a010000000000002251203409a0a1b4dac615bbb610e5f129a1a0529f577557033dad24e22900b6409baa4a01000000000000225120dad7948aeda4c13ff9ef090f9b4948b972b4a559602e1e4b7aa8d53a564d87c84a010000000000002251202874162b92b8d3be94843507d3a2c27b533e61ae775a177e7317e935be89f04f4a01000000000000225120acb9c6e99223b203a4af8b2a6ce39bb1e23c0a3123f5242f0e0b1777a53a36774a01000000000000225120ebdc247bd6c6454be70ebb16f54203e50549c5c9053350a0295696a517ceaad24a010000000000002251205b99180e687628d855fbf65bc9a78bea6ef1870465b8efdfd756fbdb9f0f34904a0100000000000022512035aeb2f8fdb9617f2b1c04c78d452f6fbf245cd77bea1a65cdd3b494d5cb594e4a010000000000002251202ab900cb03c69a017fd4b1c5c8a9b35edec599c7c614e284b4098e36d88561b84a010000000000002251205363b56d85e2af472bf6275c3f875026c4b6ed5c776dfbbeec0e75c61a4290674a01000000000000225120837089e6f39996d4b0a301838a1c146d40fb79ce32455b9390cc6ff407d0b4ad4a01000000000000225120a424305cb90773f9a9ee314d0a1172e76a5ccf20beec1b258d3965c1bdd5e25a4a01000000000000225120f91144fd8b1e43dd85684f694e797f967a9d8a5da4ede96b9c39eabc22acfac84a0100000000000022512022df0320bbaeac36f421ae05895a73e9212ac6b4c020a10c34423a2f4dd280dc4a010000000000002251208322f3cc434065f11f0f4c790f23dc103e0004c05230437973290092e7bfc89e034075397786df994c7357893590376bc7cab5aa41e780cb8614a7dd7cbd439ec830c6edebb31af447c2c4dafb2b0dfd56114d4020b797cc1247a2a658b7153d633d2220c46132cbb3ef14caeac8f724fea1449d802133495ef1675f210b0742f5ee8164ac61c12be4d02127fedf4c956f8e6d8248420b9af78746232315f72894f0b263c80e81071ef120de1128355b2ac51af4e44b327234379fadb0fafd5bb0ebf5ff6408a5078dd4bb8e3ae3fb38762d09622a24ff352f723c4584e8c76cfcf7ffcc462c7800000000";
        bitcoin::consensus::deserialize(&hex::decode(raw_block).unwrap()).unwrap()
    }

    mod data {
        use bitcoin::Transaction;
        use borsh::BorshDeserialize;
        use strata_primitives::buf::Buf32;
        use strata_state::{
            batch::{BatchCheckpoint, SignedBatchCheckpoint},
            block::L2Block,
            chain_state::ChainState,
            l1::{HeaderVerificationState, L1BlockId, TimestampStore},
        };
        use strata_tx_parser::inscription::parse_inscription_data;

        pub fn chain_state() -> ChainState {
            let data = [
                58, 78, 73, 160, 24, 209, 94, 159, 81, 194, 179, 114, 193, 119, 165, 127, 22, 129,
                57, 170, 2, 63, 34, 196, 110, 239, 47, 250, 85, 121, 216, 26, 100, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 50, 0, 0, 0, 0, 0, 0, 0, 134, 34, 122, 209, 162, 175,
                207, 255, 167, 25, 209, 15, 19, 244, 73, 116, 100, 115, 146, 230, 222, 89, 202, 3,
                174, 102, 85, 155, 165, 25, 27, 3, 80, 0, 0, 0, 0, 0, 0, 32, 125, 96, 80, 117, 14,
                86, 69, 163, 42, 239, 192, 239, 207, 3, 9, 125, 99, 95, 141, 241, 204, 226, 36,
                231, 211, 82, 164, 80, 29, 5, 115, 14, 74, 234, 158, 50, 185, 76, 208, 229, 30,
                102, 190, 19, 189, 255, 119, 64, 229, 130, 228, 56, 111, 240, 138, 170, 101, 62,
                73, 65, 159, 113, 242, 40, 46, 95, 52, 103, 255, 255, 127, 32, 2, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 79, 2, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 132, 6, 67, 190, 192, 96, 23, 187, 23, 168,
                111, 148, 17, 4, 58, 50, 250, 238, 111, 40, 43, 206, 180, 241, 210, 185, 157, 176,
                221, 29, 247, 36, 80, 0, 0, 0, 0, 0, 0, 32, 134, 34, 122, 209, 162, 175, 207, 255,
                167, 25, 209, 15, 19, 244, 73, 116, 100, 115, 146, 230, 222, 89, 202, 3, 174, 102,
                85, 155, 165, 25, 27, 3, 245, 147, 207, 252, 253, 152, 94, 82, 233, 15, 218, 9,
                128, 69, 4, 14, 67, 154, 175, 66, 73, 61, 182, 152, 61, 241, 154, 143, 112, 58,
                158, 26, 47, 95, 52, 103, 255, 255, 127, 32, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 168, 80, 56, 11, 229, 182, 101, 193, 18, 252, 41, 107, 151, 78, 111, 14,
                253, 232, 72, 152, 154, 185, 72, 124, 241, 238, 82, 199, 168, 245, 89, 73, 80, 0,
                0, 0, 0, 0, 0, 32, 132, 6, 67, 190, 192, 96, 23, 187, 23, 168, 111, 148, 17, 4, 58,
                50, 250, 238, 111, 40, 43, 206, 180, 241, 210, 185, 157, 176, 221, 29, 247, 36, 6,
                30, 100, 24, 202, 198, 205, 161, 196, 208, 54, 111, 141, 166, 137, 133, 57, 88,
                113, 69, 186, 33, 37, 168, 53, 88, 12, 215, 138, 127, 48, 237, 48, 95, 52, 103,
                255, 255, 127, 32, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 175, 41,
                66, 50, 183, 128, 112, 191, 167, 10, 107, 190, 193, 238, 196, 190, 21, 170, 195,
                12, 235, 231, 72, 248, 128, 4, 42, 27, 133, 162, 28, 80, 0, 0, 0, 0, 0, 0, 32, 168,
                80, 56, 11, 229, 182, 101, 193, 18, 252, 41, 107, 151, 78, 111, 14, 253, 232, 72,
                152, 154, 185, 72, 124, 241, 238, 82, 199, 168, 245, 89, 73, 207, 230, 24, 175,
                160, 166, 1, 67, 197, 221, 160, 16, 65, 170, 175, 200, 236, 108, 28, 114, 2, 68,
                168, 110, 162, 171, 159, 242, 249, 121, 1, 124, 49, 95, 52, 103, 255, 255, 127, 32,
                1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 217, 180, 14, 76, 33, 165, 188,
                152, 57, 77, 51, 26, 254, 160, 118, 172, 149, 144, 142, 141, 54, 99, 26, 238, 157,
                98, 185, 218, 62, 143, 210, 58, 80, 0, 0, 0, 0, 0, 0, 32, 6, 175, 41, 66, 50, 183,
                128, 112, 191, 167, 10, 107, 190, 193, 238, 196, 190, 21, 170, 195, 12, 235, 231,
                72, 248, 128, 4, 42, 27, 133, 162, 28, 115, 15, 200, 165, 227, 188, 8, 222, 230,
                29, 249, 49, 216, 147, 104, 17, 204, 237, 153, 83, 214, 186, 201, 134, 181, 112,
                134, 85, 228, 229, 139, 74, 50, 95, 52, 103, 255, 255, 127, 32, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 209, 130, 77, 168, 152, 227, 7, 218, 196, 9, 115, 95,
                15, 63, 114, 254, 172, 123, 105, 98, 42, 130, 86, 192, 47, 94, 194, 216, 90, 158,
                111, 104, 80, 0, 0, 0, 0, 0, 0, 32, 217, 180, 14, 76, 33, 165, 188, 152, 57, 77,
                51, 26, 254, 160, 118, 172, 149, 144, 142, 141, 54, 99, 26, 238, 157, 98, 185, 218,
                62, 143, 210, 58, 140, 122, 93, 37, 219, 52, 167, 148, 122, 161, 200, 88, 57, 248,
                226, 106, 172, 217, 50, 14, 3, 149, 144, 50, 41, 159, 22, 143, 239, 219, 50, 141,
                51, 95, 52, 103, 255, 255, 127, 32, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                164, 98, 250, 106, 110, 223, 63, 12, 228, 175, 212, 56, 208, 119, 59, 104, 169,
                163, 43, 201, 238, 49, 99, 155, 87, 86, 73, 67, 24, 242, 94, 106, 80, 0, 0, 0, 0,
                0, 0, 32, 209, 130, 77, 168, 152, 227, 7, 218, 196, 9, 115, 95, 15, 63, 114, 254,
                172, 123, 105, 98, 42, 130, 86, 192, 47, 94, 194, 216, 90, 158, 111, 104, 216, 162,
                78, 105, 81, 61, 143, 207, 21, 114, 174, 173, 88, 147, 239, 210, 9, 253, 233, 32,
                36, 98, 72, 112, 3, 10, 179, 56, 223, 183, 129, 74, 52, 95, 52, 103, 255, 255, 127,
                32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 55, 173, 97, 207, 241, 54,
                116, 103, 169, 140, 247, 197, 76, 74, 201, 158, 152, 159, 31, 187, 27, 193, 230,
                70, 35, 94, 144, 192, 101, 197, 101, 186, 0, 0, 0, 0, 53, 23, 20, 175, 114, 215,
                66, 89, 244, 92, 215, 234, 176, 176, 69, 39, 205, 64, 231, 72, 54, 164, 90, 188,
                174, 80, 249, 45, 145, 157, 152, 143, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 141,
                134, 131, 78, 111, 219, 69, 186, 107, 127, 253, 6, 122, 39, 185, 225, 214, 119,
                120, 4, 117, 129, 215, 239, 117, 126, 217, 224, 250, 71, 64, 0, 214, 120, 170, 42,
                213, 228, 242, 23, 64, 37, 170, 127, 119, 205, 67, 238, 102, 44, 205, 148, 73, 153,
                130, 208, 195, 34, 167, 61, 31, 254, 205, 121, 1, 0, 0, 0, 10, 187, 0, 184, 177,
                126, 39, 152, 221, 235, 208, 204, 187, 133, 139, 111, 98, 74, 31, 247, 217, 62,
                193, 91, 170, 138, 123, 227, 241, 54, 71, 77, 23, 92, 178, 109, 239, 0, 234, 239,
                64, 101, 12, 157, 97, 27, 230, 117, 15, 181, 119, 161, 12, 225, 248, 248, 94, 43,
                40, 195, 70, 219, 137, 246, 2, 0, 0, 0, 42, 75, 116, 61, 194, 57, 58, 110, 224, 56,
                53, 10, 110, 243, 165, 87, 65, 230, 199, 138, 198, 73, 20, 120, 216, 50, 244, 226,
                162, 58, 166, 190, 1, 164, 160, 232, 209, 174, 75, 16, 184, 220, 35, 13, 92, 51,
                14, 72, 148, 5, 135, 153, 139, 148, 247, 106, 94, 46, 115, 209, 68, 77, 74, 251, 2,
                0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 60, 169, 136, 46, 201, 120, 56, 22, 121, 22, 161,
                72, 76, 143, 197, 121, 140, 4, 28, 83, 73, 113, 154, 118, 29, 253, 179, 1, 75, 87,
                236, 164, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 202, 154,
                59, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 0, 0, 0, 148, 178, 95, 235, 57, 15, 190, 250,
                221, 104, 247, 193, 238, 231, 224, 196, 117, 254, 160, 209, 253, 222, 89, 186, 102,
                171, 108, 168, 25, 252, 228, 124, 0, 202, 154, 59, 0, 0, 0, 0, 0, 0, 0, 0, 119, 68,
                15, 0, 0, 0, 0, 0, 1, 0, 0, 0, 198, 251, 176, 244, 144, 110, 135, 145, 243, 12,
                155, 167, 8, 235, 206, 139, 33, 241, 125, 36, 105, 209, 148, 149, 179, 139, 22, 70,
                189, 192, 208, 62, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0,
                202, 154, 59, 0, 0, 0, 0, 0, 0, 0, 0, 1, 101, 0, 0, 0, 0, 0, 0, 0, 150, 17, 148,
                36, 147, 1, 0, 0, 58, 78, 73, 160, 24, 209, 94, 159, 81, 194, 179, 114, 193, 119,
                165, 127, 22, 129, 57, 170, 2, 63, 34, 196, 110, 239, 47, 250, 85, 121, 216, 26,
                173, 110, 193, 201, 247, 85, 170, 209, 208, 38, 228, 161, 168, 0, 211, 15, 185,
                151, 233, 204, 21, 19, 28, 103, 180, 131, 224, 232, 189, 252, 183, 97, 105, 43,
                232, 207, 197, 40, 176, 139, 119, 5, 113, 115, 59, 100, 241, 247, 71, 123, 183, 45,
                122, 209, 144, 71, 114, 93, 22, 62, 222, 115, 240, 236, 228, 92, 6, 208, 156, 3,
                147, 254, 142, 201, 5, 201, 201, 219, 134, 93, 196, 87, 163, 74, 153, 173, 156, 5,
                73, 16, 8, 230, 12, 224, 35, 35, 250, 70, 182, 87, 121, 0, 91, 157, 51, 32, 97,
                224, 167, 95, 202, 18, 139, 79, 203, 245, 127, 131, 92, 48, 83, 135, 205, 172, 163,
                8, 62, 222, 177, 118, 107, 56, 75, 231, 151, 226, 142, 155, 154, 50, 129, 241, 214,
                134, 9, 1, 230, 155, 249, 11, 220, 143, 92, 90, 131, 124, 204, 167, 188, 64, 4, 0,
                0, 0, 85, 2, 0, 0, 0, 0, 0, 0, 206, 166, 24, 183, 105, 21, 12, 12, 133, 224, 192,
                187, 118, 244, 171, 247, 156, 14, 112, 11, 252, 48, 73, 201, 101, 33, 61, 111, 121,
                191, 35, 118, 80, 0, 0, 0, 0, 0, 0, 32, 164, 98, 250, 106, 110, 223, 63, 12, 228,
                175, 212, 56, 208, 119, 59, 104, 169, 163, 43, 201, 238, 49, 99, 155, 87, 86, 73,
                67, 24, 242, 94, 106, 136, 54, 18, 28, 28, 233, 0, 133, 2, 34, 74, 24, 109, 194,
                192, 169, 109, 254, 37, 83, 32, 195, 206, 252, 64, 187, 184, 173, 29, 72, 126, 119,
                53, 95, 52, 103, 255, 255, 127, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                86, 2, 0, 0, 0, 0, 0, 0, 175, 234, 125, 192, 120, 31, 138, 252, 142, 232, 9, 123,
                144, 116, 89, 219, 103, 212, 136, 52, 71, 17, 212, 7, 180, 147, 70, 112, 183, 19,
                105, 99, 80, 0, 0, 0, 0, 0, 0, 32, 206, 166, 24, 183, 105, 21, 12, 12, 133, 224,
                192, 187, 118, 244, 171, 247, 156, 14, 112, 11, 252, 48, 73, 201, 101, 33, 61, 111,
                121, 191, 35, 118, 14, 188, 162, 138, 237, 102, 164, 196, 59, 184, 214, 113, 14,
                233, 66, 109, 125, 71, 33, 255, 129, 152, 255, 203, 96, 255, 206, 90, 61, 253, 206,
                214, 54, 95, 52, 103, 255, 255, 127, 32, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 87, 2, 0, 0, 0, 0, 0, 0, 1, 16, 8, 66, 155, 21, 150, 222, 35, 177, 220, 78,
                148, 134, 85, 159, 210, 109, 108, 32, 229, 107, 63, 141, 11, 17, 164, 41, 238, 26,
                173, 92, 80, 0, 0, 0, 0, 0, 0, 32, 175, 234, 125, 192, 120, 31, 138, 252, 142, 232,
                9, 123, 144, 116, 89, 219, 103, 212, 136, 52, 71, 17, 212, 7, 180, 147, 70, 112,
                183, 19, 105, 99, 243, 230, 52, 168, 55, 173, 193, 78, 66, 43, 85, 58, 37, 150,
                195, 123, 181, 54, 209, 6, 62, 223, 50, 219, 243, 192, 139, 187, 24, 181, 45, 204,
                55, 95, 52, 103, 255, 255, 127, 32, 1, 0, 0, 0, 233, 191, 155, 1, 0, 240, 18, 99,
                99, 67, 249, 87, 17, 191, 176, 111, 173, 111, 68, 180, 68, 138, 186, 233, 76, 72,
                227, 144, 32, 201, 222, 84, 0, 0, 0, 0, 0, 0, 0, 0, 88, 2, 0, 0, 0, 0, 0, 0, 218,
                102, 186, 35, 163, 123, 204, 22, 145, 110, 91, 158, 9, 81, 236, 234, 186, 203, 191,
                171, 198, 201, 243, 150, 140, 195, 115, 113, 178, 97, 65, 72, 80, 0, 0, 0, 0, 0, 0,
                32, 1, 16, 8, 66, 155, 21, 150, 222, 35, 177, 220, 78, 148, 134, 85, 159, 210, 109,
                108, 32, 229, 107, 63, 141, 11, 17, 164, 41, 238, 26, 173, 92, 228, 158, 11, 29,
                201, 180, 78, 103, 250, 211, 9, 160, 171, 14, 129, 206, 17, 56, 0, 233, 187, 20,
                220, 78, 118, 29, 128, 133, 147, 225, 213, 44, 56, 95, 52, 103, 255, 255, 127, 32,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 101, 0, 0, 0, 0, 0, 0, 0, 86, 232,
                31, 23, 27, 204, 85, 166, 255, 131, 69, 230, 146, 192, 248, 110, 91, 72, 224, 27,
                153, 108, 173, 192, 1, 98, 47, 181, 227, 99, 180, 33, 32, 0, 0, 0, 220, 221, 142,
                97, 128, 206, 230, 187, 217, 104, 108, 254, 97, 57, 228, 122, 184, 242, 129, 12,
                172, 127, 118, 125, 92, 163, 64, 247, 118, 32, 58, 98, 0, 0, 0, 0, 225, 178, 250,
                232, 225, 88, 59, 133, 171, 26, 135, 174, 3, 163, 90, 62, 89, 21, 174, 225, 199,
                145, 206, 23, 32, 192, 54, 78, 51, 147, 16, 79, 0, 0, 0, 0, 0, 0, 0, 0,
            ];
            borsh::from_slice::<(ChainState, L2Block)>(&data).unwrap().0
        }

        pub fn header_verification_state() -> HeaderVerificationState {
            HeaderVerificationState {
                last_verified_block_num: 605,
                last_verified_block_hash: L1BlockId::from(
                    Buf32::try_from_slice(
                        &hex::decode(
                            "228ea118e94f0c2e3464d506cb0a0b2f60be41c12deb7f4108062661682de620",
                        )
                        .unwrap(),
                    )
                    .unwrap(),
                ),
                next_block_target: 545259519,
                interval_start_timestamp: 1296688602,
                total_accumulated_pow: 0,
                last_11_blocks_timestamps: TimestampStore::new_with_head(
                    [
                        1731485491, 1731485492, 1731485493, 1731485494, 1731485495, 1731485496,
                        1731485497, 1731485498, 1731485499, 1731485500, 1731485501,
                    ],
                    0,
                ),
            }
        }

        pub fn checkpoint_last_verified_l1_height(tx: &Transaction) -> Option<u32> {
            if let Some(script) = tx.input[0].witness.tapscript() {
                if let Ok(inscription) = parse_inscription_data(&script.into(), "alpenstrata") {
                    if let Ok(signed_batch_checkpoint) =
                        borsh::from_slice::<SignedBatchCheckpoint>(inscription.batch_data())
                    {
                        let batch_checkpoint: BatchCheckpoint = signed_batch_checkpoint.into();
                        return Some(batch_checkpoint.batch_info().l1_range.1 as u32);
                    }
                }
            }
            None
        }

        pub fn superblock_period_start_ts() -> u32 {
            1731485561
        }
    }

    #[test]
    fn test_dump_proof_inputs() {
        let blocks_bytes = include_bytes!("../inputs/blocks.bin");
        let blocks: Vec<Block> = bincode::deserialize(blocks_bytes).unwrap();

        let initial_header_state = data::header_verification_state();

        let deposit_txid =
            Txid::from_str("a4ec574b01b3fd1d769a7149531c048c79c58f4c48a11679163878c92e88a93c")
                .unwrap();

        let bridge_out_txid =
            Txid::from_str("0b3662f5d269d7e1778c712a6bc17192b84e2f403b729d2963f5121c28399b1c")
                .unwrap();
        let (bridge_out_height, bridge_out_tx) = blocks
            .iter()
            .find_map(|block| {
                if let Some(tx) = block
                    .txdata
                    .iter()
                    .find(|tx| tx.compute_txid() == bridge_out_txid)
                {
                    return Some((
                        block.bip34_block_height().unwrap() as u32,
                        tx.with_inclusion_proof(block),
                    ));
                }
                None
            })
            .unwrap();

        let (checkpoint_height, checkpoint_tx) = blocks
            .iter()
            .filter(|block| {
                let height = block.bip34_block_height().unwrap() as u32;
                initial_header_state.last_verified_block_num < height && height < bridge_out_height
            })
            .rev()
            .find_map(|block| {
                if let Some(tx) = block.txdata.iter().find(|&tx| {
                    data::checkpoint_last_verified_l1_height(tx).is_some_and(|height| {
                        height == initial_header_state.last_verified_block_num
                    })
                }) {
                    return Some((
                        block.bip34_block_height().unwrap() as u32,
                        tx.with_inclusion_proof(block),
                    ));
                }
                None
            })
            .unwrap();

        let superblock_period_start_ts = data::superblock_period_start_ts();

        let mut headers = blocks
            .iter()
            .filter_map(|block| {
                if initial_header_state.last_verified_block_num
                    < block.bip34_block_height().unwrap() as u32
                    && block.header.time <= superblock_period_start_ts
                {
                    return Some(block.header);
                }
                None
            })
            .collect::<Vec<_>>();
        headers.extend(
            blocks
                .iter()
                .filter_map(|block| {
                    if block.header.time > superblock_period_start_ts {
                        return Some(block.header);
                    }
                    None
                })
                .take(SUPERBLOCK_PERIOD_BLOCK_INTERVAL),
        );

        let bridge_proof_input = BridgeProofInput {
            headers,
            deposit_txid: deposit_txid.to_byte_array(),
            checkpoint: (checkpoint_height, checkpoint_tx),
            bridge_out: (bridge_out_height, bridge_out_tx),
            initial_header_state,
            superblock_period_start_ts,
        };

        let strata_bridge_state = StrataBridgeState {
            deposits_table: data::chain_state().deposits_table().clone(),
            hashed_chain_state: data::chain_state().hashed_chain_state(),
        };

        // write_bridge_proof_input_and_state(&bridge_proof_input, &strata_bridge_state);

        // verifying proof statements
        let res = process_bridge_proof(bridge_proof_input, strata_bridge_state);

        assert!(res.is_ok());
    }

    fn write_bridge_proof_input_and_state(input: &BridgeProofInput, state: &StrataBridgeState) {
        fs::write(
            "inputs/bridge_proof_input.bin",
            bincode::serialize(input).unwrap(),
        )
        .unwrap();
        fs::write(
            "inputs/strata_bridge_state.bin",
            borsh::to_vec(state).unwrap(),
        )
        .unwrap();
    }
}
